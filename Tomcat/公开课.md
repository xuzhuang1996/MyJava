## 基础概念
### web 基础
1. 资源
   1. 静态资源：所有用户访问，得到的结果都一样。该类资源可直接被浏览器解析。如HTML、js、CSS、jpg
   2. 动态资源：每个用户访问相同的资源，得到的结果可能不一样。动态资源被访问后，需要先转换为静态资源，然后返回给浏览器解析。如servlet/jsp、PHP。
## Tomcat
### tomcat架构
1. Tomcat 的核心是两个组件：Connector 和 Container。

    <img src="https://github.com/xuzhuang1996/MyJava/blob/master/img/Tomcat/1.PNG" width=80% height=80% />
2. 连接器，称coyote。作为服务器提供给客户端访问的外部接口，客户端通过coyote与服务器建立连接、发送请求并接受响应。coyote封装了底层网络通信（socket请求以及响应处理），使得Catalina容器与具体的请求协议以及IO操作方式完全解耦。coyote将socket输入转换封装尾request对象，交给Catalina容器进行处理，处理完请求后，Catalina再通过coyote提供的response对象将结果写入输出流。

    <img src="https://github.com/xuzhuang1996/MyJava/blob/master/img/Tomcat/2.PNG" width=80% height=80% />
3. 连接器组件
   1. EndPoint,通信端点，即监听请求。
   2. Processor，将客户端发来的socket请求，转换为http请求，并对其进行解析，封装成request对象
   3. Adapter，在连接器与容器之间适配。将request转换为servletRequest对象，去调用容器中的方法。
   
     <img src="https://github.com/xuzhuang1996/MyJava/blob/master/img/Tomcat/3.PNG" width=80% height=80% />
4. Container
   1. Engine，表示整个Catalina的servlet引擎，管理多个虚拟站点，这里没理解
   2. Host，代表一个虚拟主机，可以给Tomcat配置多个虚拟主机地址，这里没理解.就是可以配置多个地址，比如配置localhost或者www.baidu.com主机地址
   3. Context，代表一个web应用程序。
   4. Wrapper，即具体servlet
### 源码
1. Lifecycle接口，由于所有组件均存在初始化、启动、停止等生命周期方法，拥有生命周期管理的特性，因此基于此抽象成该接口。
   1. init()初始化组件
   2. start()启动组件
   3. stop()停止组件
   4. destory()销毁组件
2. 请求处理。Tomcat利用Mapper组件实现：请求交付Wrapper容器的Servlet处理。首先Mapper组件保存了Web应用的配置信息（.xml），包括Host容器配置的域名、Context容器的Web应用路径、以及Wrapper容器的Servlet映射路径。如下图：
   1. 在Tomcat的server.xml的中`<Engine defaultHost="localhost" name="Catalina">`首先查找对应的Host，即定位到的资源是`<Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true">`,因为name=localhost，最终定位到的资源在webapps下面，
   2. 接着，根据URL，定位到具体应用。后面的具体Servlet的定位，则取决于应用的web.xml中的配置信息。
   
      <img src="https://github.com/xuzhuang1996/MyJava/blob/master/img/Tomcat/5.PNG" width=100% height=100% />
### jasper
1. Tomcat在默认的web.xml中配置了一个JSPServlet的类，用于处理*.jsp\*.jspx结尾的请求。另外，在conf/web.xml文件的末尾<welcome-file-list>写入了默认的页面index.jsp，即输入路径为null时默认请求地址为index.jsp。index_jsp.java在Tomcat的work/localhost路径下
   
   <img src="https://github.com/xuzhuang1996/MyJava/blob/master/img/Tomcat/6.PNG" width=80% height=80% />
2. 编译结果：
   1. 如果在conf/web.xml中配置了参数scratchdir，则编译后的结果存储在该目录下
   
            <init-param>
                 <param-name>scratchdir</param-name>
                 <param-value>D:/tmp/jsp/</param-value>
            </init-param>
   2. 如果没有配置该选项，则会将编译结果存储Tomcat的安装目录work/Catalina(Engine名称)/localhost(Host)/Context名称
   3. 如果使用IDEA开发集成的Tomcat访问Web中的jsp，则编译结果：`C:\Users\Administrator\.Intel1iJIdea2019.l\system\tomcat\ _project_tomcat\work\Catalina\localhost\jsp_demo_01_wa r_exploded\org\apache\jsp`
   
   
   
   
### Tomcat服务器配置
主要集中于/conf下的文件

1. server.xml，Server作为根节点，`<Server port="8005" shutdown="SHUTDOWN">`表示执行shutdown时监听该行为的端口号为8005：
    1. 接着配置了5个监听器。VersionLoggerListener用于日志输出服务器、操作系统、JVM版本信息，AprLifecycleListener用于加载服务器启动和销毁APR，如果找不到APR库，则输出日志，但不影响Tomcat启动。
    1. Service,创建Service实例。
       - Executor被注释了，表示多个连接器使用单独的线程池，取消注释则表明多个连接器公用一个线程池。
       - Connector，默认创建2个实例，以后支持HTTP，一个支持AJP，port用于创建服务器socket并进行监听。redirectPort,即当前Connector不支持SSL请求，会自动重定向到该端口号。URIEncoding:用于指定编码URI的字符编码，Tomcat8以上默认UTF-8，get请求乱码不用处理，但7及以下默认ISO-8859-1
       - Engine：defaultHost属性表示默认访问该主机下的信息。这里可以自己添加虚拟主机。
       - Context：应用存放docBase路径，或者war包的部署路径。path是web应用的Context路径。即主机地址+path为访问路径。
### web应用配置
1. web.xml
   1. <context-param>标签为ServletContext初始化参数，这样我们可以在javax.servlet.Servletcentext.getInitParameter()方法获取参数。
   
### Tomcat管理配置
1. webapps下的host-manager管理虚拟主机信息，而manager管理web应用。
### JVM配置
1. windows下的bin/catalina.bat文件下进行设置。配置好后，在Tomcat的主页右上角点击Server Status可以查到服务器的JVM信息。linxu应该就是.sh

### Tomcat集群
1. 在一台服务器上，安装2台Tomcat，conf/server.xml中分别修改三处端口号：
   1. Server标签的监听端口8005->8015\8025
   2. Connector标签的http协议的端口8080->8888\9999,这个就是后面连接访问的端口
   3. Connector标签的ajp协议的端口8009->8019\8029
2. 配置nginx，即conf/nginx.conf。当以localhost:99来访问时，访问到了nginx，最终则通过serverpool来找到Tomcat

         #Tomcat集群的nginx配置
         upstream serverpool{
            server localhost:8888;
            server localhost:9999;
         }
         server{
            listen 99;
            server_name localhost;
            # 路径是所有
            location / {
               # 代理地址
               proxy_pass http://serverpool/;
            }
         }
         
1. 测试：更改webapps/ROOT/index.jsp，后面访问的地址是在个，启动：bin/startup.bat。如果出现闪退。[解决方式](https://blog.csdn.net/znn626/article/details/7893555)。访问localhost:99就发现，由nginx负责负载均衡，有时候会访问不同内容。  
   - pause 防止命令框一闪而过
   - run 作用打印出 一闪而过的原因。
1. session复制。如果没有采用IP哈希的方式处理负载均衡，可能出现session不统一的问题。解决该问题：
   1. 需要在conf/server.xml中修改：在Engine标签中添加下面语句，通过TCP的形式进行广播复制

           <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/>
   2. 在应用程序中的web.xml中添加	<distributable/>标签
